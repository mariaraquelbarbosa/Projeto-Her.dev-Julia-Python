using HTTP
using JSON
using DataFrames
using Dates

struct FMIDataset
    """This struct represents datasets that can be extracted from the FMI API"""
    database_id::String
    base_url::String
end

function FMIDataset(database_id::String)
    base_url = "http://dataservices.imf.org/REST/SDMX_JSON.svc/CompactData/$database_id"
    return FMIDataset(database_id, base_url)
end

function joiner(input_lists::Vararg{Array})
    joined_strings = tuple([join(input_list, "+") for input_list in input_lists]...)
    return joined_strings
end

function fetch_data(dataset::FMIDataset, frequency::String, region::String, indicator::String)
    # Construct the full URL
    url = "$(dataset.base_url)/$frequency.$region.$indicator"
    
    # Request data from the API
    response = JSON.parse(String(HTTP.request("GET", url).body))
    return response
end

function process_data(response)
    # Access the 'Series' key to get the list of indicators
    indicadores = response["CompactData"]["DataSet"]["Series"]
    
    df = DataFrame(
        "Código do indicador" => Vector{Union{String}}(),
        "Localização" => Vector{Union{String}}(),
        "Período" => Vector{Union{String}}(),
        "Valor" => Vector{Union{String, Missing}}()
    )
    # Access the 'Series' key to get the list of indicators
    indicadores = response["CompactData"]["DataSet"]["Series"]

    # Iterate over the lists of indicators
    for indicador in indicadores
        for obs in indicador["Obs"]
            dataset_info = Dict(
                "Código do indicador" => indicador["@INDICATOR"],
                "Localização" => indicador["@REF_AREA"],
                "Período" => get(obs, "@TIME_PERIOD", missing),
                "Valor" => get(obs, "@OBS_VALUE", missing)
            )
            push!(df, dataset_info)
        end
    end
    
    return df
end

function get_indicator(dataset::FMIDataset, frequency_list::Vector{String}, region_list::Vector{String}, indicator_list::Vector{String})
    frequency, region, indicator = joiner(frequency_list, region_list, indicator_list)
    response = fetch_data(dataset, frequency, region, indicator)
    df = process_data(response)
    return df
end

# Example usage
base = FMIDataset("FAS")
frequency_list = ["A"]
region_list = ["AE"]
indicator_list = ["FCROFNMFHF_NUM", "FCDODCHF_PE_NUM"]

df = get_indicator(base, frequency_list, region_list, indicator_list)
println(df)

using DataFrames
using Plots

function plot_fmi_data(region="CV", frequency="A", male_index="FCDODCHMMA_NUM", female_index ="FCDODCHFFA_NUM")

	# Crie um FMIDataset com a frequência e região especificadas
	base = FMIDataset("FAS")
    
    # Obtenha o DataFrame com os indicadores, frequência e região especificados
    df = get_indicator(base, [frequency], [region], [male_index, female_index])
    
    # Converta a coluna 'Valor' para Float64
    df.Valor = parse.(Float64, df.Valor)
    
    # Filtrar os dados para o índice masculino
    male_data = filter(row -> row["Código do indicador"] == male_index, df)
    female_data = filter(row -> row["Código do indicador"] == female_index, df)
    
    # Inicialize o gráfico
    p = plot(grid=false)
    
    # Scatterplot e gráfico de linha para o índice masculino
    scatter!(male_data.Período, male_data.Valor, label = "Sexo Masculino", color = "purple")
    plot!(male_data.Período, male_data.Valor, label = nothing, color = "purple")
    
    # Scatterplot e gráfico de linha para o índice masculino
    scatter!(female_data.Período, female_data.Valor, label = "Sexo Feminino", color = "red")
    plot!(female_data.Período, female_data.Valor, label = nothing, color = "red")
   
    # Personalize o gráfico
    xlabel!("Ano")
    ylabel!("Valor")
    title!(female_index)
    
    display(p)
end
